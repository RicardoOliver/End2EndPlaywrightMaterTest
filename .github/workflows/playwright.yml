name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  test:
    if: ${{ github.event_name != 'pull_request' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        node: [ 20, 22 ]
        shard: [ 1/2, 2/2 ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          # cache disabled to avoid warnings when lockfile is absent

      - name: Cache Playwright browsers (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-playwright-


      - name: Install dependencies
        if: ${{ hashFiles('package-lock.json') != '' }}
        run: npm ci

      - name: Install dependencies (fallback)
        if: ${{ hashFiles('package-lock.json') == '' }}
        run: npm install --no-fund --no-audit

      - name: Install Playwright Browsers (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: npx playwright install --with-deps

      # Non-ubuntu browsers install step removed (matrix uses only ubuntu)

      - name: Sanitize shard name
        run: echo "SHARD_NAME=${{ matrix.shard }}" | sed 's/\//-/g' >> $GITHUB_ENV

      - name: Run Playwright tests (full suite, shard ${{ matrix.shard }})
        env:
          PW_FAST: true
        run: npx playwright test --max-failures=1 --shard=${{ matrix.shard }}

      - name: Check test results directory
        id: check_results
        run: |
          if [ -d test-results ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.os }}-node${{ matrix.node }}-shard${{ env.SHARD_NAME }}
          path: reports/html
          if-no-files-found: warn
          retention-days: 30
          overwrite: true

      - name: Upload JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-json-${{ matrix.os }}-node${{ matrix.node }}-shard${{ env.SHARD_NAME }}
          path: reports/report.json
          if-no-files-found: warn
          retention-days: 30
          overwrite: true

      - name: Upload raw test results
        if: always() && steps.check_results.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-node${{ matrix.node }}-shard${{ env.SHARD_NAME }}
          path: test-results
          if-no-files-found: ignore
          retention-days: 30
          overwrite: true

      - name: Create failure issue (main/develop)
        if: failure() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const p = 'reports/report.json'
            let body = 'Playwright job failed on ' + context.ref + "\n\n"
            if (fs.existsSync(p)) {
              const data = JSON.parse(fs.readFileSync(p, 'utf8'))
              const suites = Array.isArray(data.suites) ? data.suites : []
              const failures = []
              for (const s of suites) {
                const specs = Array.isArray(s.specs) ? s.specs : []
                for (const sp of specs) {
                  if (sp.ok === false) failures.push(sp)
                }
              }
              const lines = failures.map(f => `• ${f.title} (${f.file || 'unknown file'})`)
              body += failures.length > 0
                ? `Falhas (${failures.length}):\n${lines.join('\n')}\n\nArtefatos anexados: HTML, JSON e test-results.`
                : 'Falha detectada, mas nenhum teste quebrado identificado no JSON.'
            } else {
              body += 'report.json não encontrado.'
            }
            const title = `CI falhou: ${context.runId}`
            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            })
            core.info(`Issue criada #${res.data.number}`)

      - name: Setup Java for Allure
        if: always()
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Restore Allure history (Linux)
        uses: actions/cache/restore@v4
        with:
          path: allure-results/history
          key: allure-history-${{ github.ref }}
          restore-keys: |
            allure-history-

      - name: Copy categories.json if present (Linux)
        run: |
          if [ -f allure/categories.json ]; then
            mkdir -p allure-results
            cp allure/categories.json allure-results/categories.json
          fi

      - name: Generate Allure report
        if: always()
        run: |
          npm run report:allure
      - name: Add Allure local serve helper (Linux)
        if: always()
        run: |
          mkdir -p reports/allure || true
          printf '#!/usr/bin/env bash\n\nnpx allure-commandline open reports/allure\n' > reports/allure/open.sh
          chmod +x reports/allure/open.sh

      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-${{ matrix.os }}-node${{ matrix.node }}-shard${{ env.SHARD_NAME }}
          path: reports/allure
          if-no-files-found: warn
          retention-days: 30
          overwrite: true

      - name: Prepare Allure history for cache (Linux)
        if: always()
        run: |
          mkdir -p allure-results/history
          if [ -d reports/allure/history ]; then
            cp -r reports/allure/history/. allure-results/history/
          fi

      - name: Save Allure history cache (Linux)
        if: ${{ matrix.shard == '2/2' && matrix.node == 20 }}
        uses: actions/cache/save@v4
        with:
          path: allure-results/history
          key: allure-history-${{ github.ref }}-${{ matrix.os }}-node${{ matrix.node }}-shard${{ env.SHARD_NAME }}

      - name: Upload Allure report to Pages artifact
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && matrix.node == 20 && matrix.shard == '1/2' }}
        uses: actions/upload-pages-artifact@v4
        with:
          path: reports/allure

  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm install --no-fund --no-audit
      - name: Ensure reports directory exists
        run: mkdir -p reports
      - name: Run k6 performance test
        uses: grafana/k6-action@v0.2.0
        with:
          filename: performance/basic.k6.js
          flags: --summary-export=reports/k6-summary.json
        env:
          BASE_URL: ${{ vars.BASE_URL || secrets.BASE_URL || 'https://automationintesting.online/' }}
      - name: Generate k6 summary HTML
        run: |
          mkdir -p reports || true
          chmod -R u+w reports || true
          node -e "const fs=require('fs'); const path=require('path'); const p='reports/k6-summary.json'; if(fs.existsSync(p)){ const data=fs.readFileSync(p,'utf8'); const html='<!doctype html><html><head><meta charset=\'utf-8\'><title>K6 Summary</title><style>body{font-family:system-ui,Arial,sans-serif;padding:20px;}pre{white-space:pre-wrap;word-wrap:break-word;background:#f6f8fa;padding:16px;border-radius:8px;border:1px solid #ddd;}h1{margin-top:0}</style></head><body><h1>K6 Summary</h1><pre>'+data+'</pre></body></html>'; const out1=path.join('reports','k6-summary.html'); try { fs.writeFileSync(out1, html); console.log('k6 summary HTML generated at '+out1); } catch(e){ const tmp=process.env.RUNNER_TEMP || process.cwd(); const out2=path.join(tmp,'k6-summary.html'); fs.writeFileSync(out2, html); console.log('k6 summary HTML generated at '+out2+' (fallback)'); } } else { console.log('k6 summary JSON not found'); }"
      - name: Upload k6 summary HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-summary-html
          path: reports/k6-summary.html
          if-no-files-found: warn
      - name: Upload k6 summary JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-summary-json
          path: reports/k6-summary.json
          if-no-files-found: warn

  update_media_video_pr:
    if: ${{ github.event_name == 'pull_request' }}
    needs: [test_smoke_pr]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download smoke test results artifact
        uses: actions/download-artifact@v4
        with:
          name: smoke-test-results
          path: smoke_artifacts
      - name: Find and convert latest video to MP4
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg || true
          mkdir -p docs/media
          WEBMS=$(ls -t smoke_artifacts/**/*.webm 2>/dev/null || true)
          LIST="videos.txt"
          : > "$LIST"
          for f in $WEBMS; do
            out="${f%.*}.mp4"
            ffmpeg -y -i "$f" -c:v libx264 -preset ultrafast -c:a aac "$out" || true
            echo "file '$out'" >> "$LIST"
          done
          if [ -s "$LIST" ]; then
            ffmpeg -y -f concat -safe 0 -i "$LIST" -c:v libx264 -preset veryfast -c:a aac docs/media/demo.mp4 || true
          fi
      - name: Commit media updates
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/media/demo.mp4 || true
          git commit -m "docs(media): update demo video from latest PR run" || true
          git push || true

  update_media_perf:
    needs: [performance]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download k6 summary HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: k6-summary-html
          path: .
      - name: Screenshot k6 summary to PNG
        run: |
          mkdir -p docs/media
          HTML="reports/k6-summary.html"
          if [ ! -f "$HTML" ] && [ -f "k6-summary-html/reports/k6-summary.html" ]; then
            mkdir -p reports
            cp "k6-summary-html/reports/k6-summary.html" "$HTML"
          fi
          if [ -f "$HTML" ]; then
            npm ci || npm install --no-fund --no-audit
            npx playwright install chromium
            node -e '
              const { chromium } = require("playwright");
              (async () => {
                const browser = await chromium.launch();
                const page = await browser.newPage({ viewport: { width: 1280, height: 720 } });
                await page.goto("file://" + process.cwd() + "/reports/k6-summary.html");
                await page.waitForTimeout(1000);
                await page.screenshot({ path: "docs/media/grafana-dashboard.png" });
                await browser.close();
              })();
            '
          fi
      - name: Commit performance image
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/media/grafana-dashboard.png || true
          git commit -m "docs(media): update Grafana-style performance image from k6 summary" || true
          git push || true

  update_media_video_push:
    if: ${{ github.event_name == 'push' }}
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download all test results artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: all_results
      - name: Find and convert latest video to MP4
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg || true
          mkdir -p docs/media
          FILE=$(ls -t all_results/**/*.webm 2>/dev/null | head -n1 || true)
          if [ -n "$FILE" ]; then
            ffmpeg -y -i "$FILE" -c:v libx264 -preset ultrafast -c:a aac docs/media/demo.mp4 || true
          fi
      - name: Commit media updates (push)
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/media/demo.mp4 || true
          git commit -m "docs(media): update demo video from latest push run" || true
          git push || true

  record_demo_video_push:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps and browsers
        run: |
          npm ci || npm install --no-fund --no-audit
          npx playwright install --with-deps
      - name: Run demo test with video
        env:
          PW_FAST: false
          PW_VIDEO: on
        run: |
          npx playwright test tests/smoke/homepage.spec.ts --project=chromium -g "Homepage loads successfully" || true
      - name: Convert latest demo webm to mp4
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg || true
          mkdir -p docs/media
          FILE=$(ls -t test-results/**/*.webm 2>/dev/null | head -n1 || true)
          if [ -n "$FILE" ]; then
            ffmpeg -y -i "$FILE" -c:v libx264 -preset ultrafast -c:a aac docs/media/demo.mp4 || true
          fi
      - name: Commit demo video
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/media/demo.mp4 || true
          git commit -m "docs(media): update demo.mp4 from recorded demo test" || true
          git push || true

      # Notifications step removed (was disabled)

  test_smoke_pr:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: true
      matrix:
        node: [ 20 ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - name: Install dependencies
        run: npm ci || npm install --no-fund --no-audit
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Select impacted tests
        id: tia
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD || true)
          FILES=""
          for f in $CHANGED; do
            case "$f" in
              pages/*)
                NAME=$(basename "$f" .ts)
                FOUND=$(grep -rl "$NAME" tests || true)
                FILES="$FILES $FOUND"
                ;;
              tests/*)
                FILES="$FILES $f"
                ;;
            esac
          done
          FILES=$(echo $FILES | xargs -n1 | sort -u | xargs)
          echo "TEST_FILES=$FILES" >> $GITHUB_ENV
      - name: Run smoke tests (fast)
        env:
          PW_FAST: true
          PW_VIDEO: on
        run: |
          if [ -n "${TEST_FILES}" ]; then
            npx playwright test ${TEST_FILES} --max-failures=1 || npx playwright test tests/smoke --max-failures=1
          else
            npx playwright test tests/smoke --max-failures=1
          fi
      - name: Upload HTML report (smoke)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-reports-html
          path: reports/html
          if-no-files-found: warn
          retention-days: 7
          overwrite: true
      - name: Upload JSON report (smoke)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report-json
          path: reports/report.json
          if-no-files-found: warn
          retention-days: 7
          overwrite: true

      - name: Upload raw test results (smoke)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-results
          if-no-files-found: warn
          retention-days: 7
          overwrite: true

      - name: Comment failure summary on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const p = 'reports/report.json'
            if (!fs.existsSync(p)) {
              core.warning('report.json not found')
              return
            }
            const data = JSON.parse(fs.readFileSync(p, 'utf8'))
            const suites = Array.isArray(data.suites) ? data.suites : []
            const failures = []
            for (const s of suites) {
              const specs = Array.isArray(s.specs) ? s.specs : []
              for (const sp of specs) {
                if (sp.ok === false) failures.push(sp)
              }
            }
            const lines = failures.map(f => `• ${f.title} (${f.file || 'unknown file'})`)
            const body = failures.length > 0
              ? `CI falhou em ${failures.length} teste(s):\n${lines.join('\n')}\n\nArtefatos anexados: HTML, JSON e test-results.`
              : `CI falhou, mas não foi possível identificar testes a partir do JSON.`
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            })

  test_windows_scheduled:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ windows-latest ]
        node: [ 20 ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - name: Cache Playwright browsers (Windows)
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-playwright-
      - name: Install dependencies
        run: npm ci || npm install --no-fund --no-audit
      - name: Install Playwright Browsers
        run: npx playwright install
      - name: Run Playwright tests (Windows scheduled)
        env:
          PW_FAST: true
        run: npx playwright test --project=chromium --max-failures=1
      - name: Setup Java for Allure
        if: always()
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - name: Generate Allure report
        if: always()
        continue-on-error: true
        run: |
          npm run report:allure

      - name: Restore Allure history (Windows)
        uses: actions/cache/restore@v4
        with:
          path: allure-results/history
          key: allure-history-${{ github.ref }}
          restore-keys: |
            allure-history-

      - name: Copy categories.json if present (Windows)
        run: |
          if (Test-Path 'allure/categories.json') {
            New-Item -ItemType Directory -Force -Path 'allure-results' | Out-Null
            Copy-Item 'allure/categories.json' 'allure-results/categories.json' -Force
          }
      - name: Add Allure local serve helper (Windows)
        if: always()
        run: |
          $content = "npx allure-commandline open reports/allure"
          New-Item -ItemType File -Force -Path "reports/allure/open.ps1" -Value $content
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-reports-html-node${{ matrix.node }}
          path: reports/html
          if-no-files-found: warn
          retention-days: 30
          overwrite: true
      - name: Upload JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-report-json-node${{ matrix.node }}
          path: reports/report.json
          if-no-files-found: warn
          retention-days: 30
          overwrite: true
      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-allure-node${{ matrix.node }}
          path: reports/allure
          if-no-files-found: warn
          retention-days: 30
          overwrite: true

      - name: Prepare Allure history for cache (Windows)
        if: always()
        run: |
          New-Item -ItemType Directory -Force -Path 'allure-results/history' | Out-Null
          if (Test-Path 'reports/allure/history') {
            Copy-Item -Recurse -Force 'reports/allure/history/*' 'allure-results/history/'
          }

      - name: Save Allure history cache (Windows)
        if: ${{ matrix.node == 20 }}
        uses: actions/cache/save@v4
        with:
          path: allure-results/history
          key: allure-history-${{ github.ref }}-windows-node${{ matrix.node }}
  deploy_pages:
    needs: [test]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.PAGES_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy Allure to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  sonarcloud_scan:
    name: SonarCloud Scan
    needs: [test]
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        if: ${{ env.SONAR_TOKEN != '' && vars.SONAR_ORG != '' && vars.SONAR_PROJECT_KEY != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ vars.SONAR_ORG }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,reports/**,test-results/**,.github/**,playwright-report/**,dist/**,build/**
            -Dsonar.test.inclusions=tests/**/*

      - name: Sonar Quality Gate
        id: sonar-quality-gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        if: ${{ env.SONAR_TOKEN != '' && vars.SONAR_ORG != '' && vars.SONAR_PROJECT_KEY != '' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          pollingTimeoutSec: 600
